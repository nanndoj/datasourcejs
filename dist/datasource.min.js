angular.module("datasourcejs",[]).factory("DatasetManager",["$http","$q","$timeout","$rootScope",function(p,f,g,q){this.datasets={};var h=function(a){this.data=[];this.name=a;this.keys=[];this.enabled=!0;this.endpoint=null;this.active={};this.editing=this.inserting=!1;this.fetchSize=2;this.observers=[];this.rowsPerPage=null;this.append=!0;this._activeValues=this.headers=null;this.errorMessage="";var b=0,r=null,n,k=!1,d=!1,t=this,f=null;this.init=function(){r={save:function(e){return this.call(t.entity,
"POST",e,!0)},update:function(e,a){return this.call(e,"PUT",a)},remove:function(e){return this.call(e,"DELETE",null,!0)},call:function(e,a,c){var b;d=!0;this.$promise=p({method:a,url:e,data:c?JSON.stringify(c):null,headers:t.headers}).success(function(e){d=!1;b&&b(e)}).error(function(e){d=!1;t.handleError(e)});this.$promise.then=function(e){b=e};return this}};this.isBusy=function(){return d};this.handleError=function(e){var a="";e&&401===e.status?a="Username or passoword invalid!":e&&"[object String]"===
Object.prototype.toString.call(e.responseText)&&(a=(a=/<h1>(.*)<\/h1>/gmi.exec(e.responseText))&&2<=a.length?a[1]:e.responseText);this.errorMessage=a};this.observers&&0<this.observers.length&&q.$watch(function(){return this.active}.bind(this),function(e){e&&this.notifyObservers(e)}.bind(this),!0)};this.insert=function(e,a){r.save(e).$promise.then(a)};this.update=function(e,a){var c=h(e),b=this.entity,d="",u;for(u in c)c.hasOwnProperty(u)&&(d+="/"+c[u]);r.update(b+d,e).$promise.then(a)};this.post=
function(){this.inserting?this.insert(this.active,function(a){this.data.push(a);this.active=a}.bind(this)):this.editing&&this.update(this.active,function(a){var b=h(a);this.data.forEach(function(c){var m,d;for(d in b)m=c[d]&&c[d]===b[d]?!0:!1;m&&this.copy(a,c)}.bind(this))}.bind(this));this.inserting=this.editing=!1};this.cancel=function(){this.inserting&&(this.active=this.data[0]);this.editing=this.inserting=!1};this.startInserting=function(){this.inserting=!0;this.active={};if(this.onStartInserting)this.onStartInserting()};
this.startEditing=function(a){a&&(this.active=this.copy(a));this.editing=!0};this.remove=function(a,b){var c=function(a,e){a||(a=this.active);var b=h(a),c="",l;for(l in b)b.hasOwnProperty(l)&&(c+="/"+b[l]);e=e||function(){for(var a=0;a<this.data.length;a++){var e,c;for(c in b)b.hasOwnProperty(c)&&(e=this.data[a][c]&&this.data[a][c]===b[c]?!0:!1);e&&(this.data.splice(a,1),this.active=0<a?this.data[a-1]:null)}}.bind(this);r.remove(this.entity+c).$promise.then(e)}.bind(this);this.deleteMessage&&0<this.deleteMessage.length?
confirm(this.deleteMessage)&&c(a,b):c(a,b)};var h=function(a){for(var b={},c=0;c<this.keys.length;c++)b[this.keys[c]]=a[this.keys[c]];return b}.bind(this);this.hasNext=function(){return this.data&&b<this.data.length-1};this.hasPrevious=function(){return this.data&&0<b};this.order=function(a){n.order=a};this.getActiveValues=function(){this.active&&!this._activeValues&&q.$watch(function(){return this.active}.bind(this),function(){this._activeValues=this.getRowValues(this.active)}.bind(this),!0);return this._activeValues};
this.__defineGetter__("activeValues",function(){return t.getActiveValues()});this.getRowValues=function(a){var b=[],c;for(c in a)a.hasOwnProperty(c)&&b.push(a[c]);return b};this.next=function(){this.hasNext()||this.nextPage();return this.active=this.copy(this.data[++b],{})};this.nextPage=function(){this.hasNextPage()&&(this.offset=parseInt(this.offset)+parseInt(this.rowsPerPage),this.fetch(n,{success:function(a){if(!a||a.length<parseInt(this.rowsPerPage))this.offset=parseInt(this.offset)-this.data.length}}))};
this.prevPage=function(){this.append||this.preppend||(this.offset=parseInt(this.offset)-this.data.length,0>this.offset?this.offset=0:0<=this.offset&&this.fetch(n,{success:function(a){a&&0!==a.length||(this.offset=0)}}))};this.hasNextPage=function(){return k&&-1!=this.rowsPerPage};this.hasPrevPage=function(){return 0<this.offset&&!this.append&&!this.prepend};this.previous=function(){if(!this.hasPrevious())throw"Dataset Overflor Error";return this.active=this.copy(this.data[--b],{})};this.goTo=function(a){for(var l=
0;l<this.data.length;l++)if(this.data[l][this.key]===a)return b=l,this.active=this.copy(this.data[b],{})};this.getCursor=function(){return b};this.filter=function(a){var b=this.offset;this.offset=0;this.fetch({path:a},{beforeFill:function(){this.cleanup()},error:function(){this.offset=b}})};this.cleanup=function(){this.offset=0;this.data=[];this.cursor=-1;this.active=null;k=!1};this.current=function(){return this.active||this.data[0]};this.fetch=function(a,l){if(!this.busy)if(this.enabled){var c=
a||{},m=l||{};c.params=c.params||{};var f=this.entity+(c.path||"");0<this.rowsPerPage&&(c.params.limit=this.rowsPerPage,c.params.offset=this.offset);this.stopAutoPost();n=c;d=!0;this.$promise=p({method:"GET",url:f,params:c.params,headers:this.headers}).success(function(a){d=!1;g(a)}.bind(this)).error(function(a){d=!1;this.handleError(a);m.error&&m.error.call(this,a)}.bind(this));var g=function(a){a&&("[object Array]"!==Object.prototype.toString.call(a)&&(a=[a]),m.beforeFill&&m.beforeFill.apply(this,
this.data),this.prepend&&(this.data=a.concat(this.data)),this.append&&(this.data=this.data.concat(a)),this.prepend||this.append||(this.data=a,this.active=a[0],b=0),m.success&&m.success.call(this,a),k=a.length>=this.rowsPerPage,this.autoPost&&this.startAutoPost())}.bind(this)}else this.cleanup()};this.notifyObservers=function(){for(var a in this.observers)if(this.observers.hasOwnProperty(a)){var b=this.observers[a];g(function(){b.notify.call(b,this.active)}.bind(this),1)}};this.notify=function(a){if(a){var b=
this.watchFilter,b=b.replace(/\{([A-z][A-z|0-9]*)\}/gim,function(b,d){return a.hasOwnProperty(d)?a[d]:""});this.fetch({params:{q:b}})}};this.addObserver=function(a){this.observers.push(a)};this.copy=function(a,b){if(null===a||"[object Object]"!==Object.prototype.toString.call(a))return a;b=b||{};for(var c in a)a.hasOwnProperty(c)&&-1==c.indexOf("$")&&(b[c]=this.copy(a[c]));return b};this.startAutoPost=function(){f=q.$watch(function(){return this.data}.bind(this),function(a,b){if(this.enabled){var c=
a.length-b.length;if(0<c)for(var d=1;d<=c;d++)this.insert(a[a.length-d],function(){});else if(0>c)for(c=b.filter(function(b){return 0==a.filter(function(a){var c;a:{c=h(b);a=h(a);for(var d in c)if(c.hasOwnProperty(d)){if(!a.hasOwnProperty(d)){c=!1;break a}if(c[d]!==a[d]){c=!1;break a}}c=!0}return c}).length}),d=0;d<c.length;d++)this.remove(c[d],function(){})}else f()}.bind(this))};this.stopAutoPost=function(){f&&(f(),f=void 0)}};this.storeDataset=function(a){this.datasets[a.name]=a};this.initDataset=
function(a){var b=new h(a.name);b.entity=a.entity;b.keys=a.keys&&0<a.keys.length?a.keys.split(","):[];b.rowsPerPage=a.rowsPerPage?a.rowsPerPage:100;b.append=a.append;b.prepend=a.prepend;b.endpoint=a.endpoint;b.filterURL=a.filterURL;b.autoPost=a.autoPost;b.deleteMessage=a.deleteMessage;b.enabled=a.enabled;b.offset=a.offset?a.offset:0;if(a.headers&&0<a.headers.length){b.headers={};for(var f=a.headers.trim().split(";"),g,k=0;k<f.length;k++)g=f[k].split(":"),2===g.length&&(b.headers[g[0]]=g[1])}b.init();
this.storeDataset(b);a.lazy||"[object String]"===Object.prototype.toString.call(a.watch)||a.filterURL||b.fetch({params:{}},{success:function(a){a&&0<a.length&&(this.active=a[0],this.cursor=0)}});a.lazy&&a.autoPost&&b.startAutoPost();a.watch&&"[object String]"===Object.prototype.toString.call(a.watch)&&(this.registerObserver(a.watch,b),b.watchFilter=a.watchFilter);a.filterURL&&0<a.filterURL.length&&b.filter(a.filterURL);q[b.name]=b;return window[b.name]=b};this.registerObserver=function(a,b){this.datasets[a].addObserver(b)};
return this}]).directive("datasource",["DatasetManager","$timeout",function(p,f){var g;return{restrict:"E",scope:!0,template:"",link:function(q,h,a){(function(){var b={name:a.name,entity:a.entity,enabled:a.hasOwnProperty("enabled")?"true"===a.enabled:!0,keys:a.keys,endpoint:a.endpoint,lazy:a.hasOwnProperty("lazy")&&""===a.lazy||"true"===a.lazy,append:!a.hasOwnProperty("append")||"true"===a.append,prepend:a.hasOwnProperty("prepend")&&""===a.prepend||"true"===a.prepend,watch:a.watch,rowsPerPage:a.rowsPerPage,
offset:a.offset,filterURL:a.filter,watchFilter:a.watchFilter,deleteMessage:a.deleteMessage,headers:a.headers,autoPost:a.hasOwnProperty("autoPost")&&""===a.autoPost||"true"===a.autoPost},h=!0,n=!0,k=!0,d=p.initDataset(b);a.$observe("filter",function(a){h?f(function(){h=!1}):(f.cancel(g),g=f(function(){d.filter(a)},200))});a.$observe("enabled",function(a){k?f(function(){k=!1}):(d.enabled="true"===a,d.fetch({params:{}}))});a.$observe("entity",function(a){d.entity=a;n?f(function(){n=!1}):d.fetch({params:{}})})})()}}}]).directive("datasourceName",
["DatasetManager","$parse",function(p,f){return{restrict:"A",scope:!0,link:function(g,q,h){g.data=p.datasets;g.data[h.datasourceName]?g.datasource=g.data[h.datasourceName]:(g.datasource={},g.datasource.data=f(h.datasourceName)(g))}}}]);