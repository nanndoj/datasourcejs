angular.module("datasourcejs",[]).factory("DatasetManager",["$http","$q","$timeout","$rootScope",function(p,e,f,n){this.datasets={};var u=function(b){this.data=[];this.name=b;this.keys=[];this.enabled=!0;this.endpoint=null;this.active={};this.editing=this.inserting=!1;this.fetchSize=2;this.observers=[];this.rowsPerPage=null;this.append=!0;this._activeValues=this.headers=null;this.errorMessage="";var a=0,v=null,m,q=!1,k=!1,l=this,r=null;this.init=function(){v={save:function(c){return this.call(l.entity,
"POST",c,!0)},update:function(c,a){return this.call(c,"PUT",a)},remove:function(c){return this.call(c,"DELETE",null,!0)},call:function(c,a,d,b){var h;k=!0;this.$promise=p({method:a,url:c,data:d?JSON.stringify(d):null,headers:l.headers}).success(function(c,a,d,t){k=!1;h&&h(c)}).error(function(c,a,d,t){k=!1;l.handleError(c)});this.$promise.then=function(c){h=c};return this}};this.isBusy=function(){return k};this.handleError=function(c){var a="";c&&401===c.status?a="Username or passoword invalid!":c&&
"[object String]"===Object.prototype.toString.call(c.responseText)&&(a=(result=/<h1>(.*)<\/h1>/gmi.exec(c.responseText))&&2<=result.length?result[1]:c.responseText);this.errorMessage=a};this.observers&&0<this.observers.length&&n.$watch(function(){return this.active}.bind(this),function(c){c&&this.notifyObservers(c)}.bind(this),!0)};this.insert=function(c,a){v.save(c).$promise.then(a)};this.update=function(c,a){var d=e(c),b=this.entity,h="",w;for(w in d)d.hasOwnProperty(w)&&(h+="/"+d[w]);v.update(b+
h,c).$promise.then(a)};this.post=function(){this.inserting?this.insert(this.active,function(c){this.data.push(c);this.active=c}.bind(this)):this.editing&&this.update(this.active,function(c){var a=e(c);this.data.forEach(function(d){var b,h;for(h in a)b=d[h]&&d[h]===a[h]?!0:!1;b&&this.copy(c,d)}.bind(this))}.bind(this));this.inserting=this.editing=!1};this.cancel=function(){this.inserting&&(this.active=this.data[0]);this.editing=this.inserting=!1};this.startInserting=function(){this.inserting=!0;this.active=
{};if(this.onStartInserting)this.onStartInserting()};this.startEditing=function(c){c&&(this.active=this.copy(c));this.editing=!0};this.remove=function(c,a){var d=function(a,c){a||(a=this.active);var d=e(a),b="",t;for(t in d)d.hasOwnProperty(t)&&(b+="/"+d[t]);c=c||function(){for(var a=0;a<this.data.length;a++){var c,b;for(b in d)d.hasOwnProperty(b)&&(c=this.data[a][b]&&this.data[a][b]===d[b]?!0:!1);c&&(this.data.splice(a,1),this.active=0<a?this.data[a-1]:null)}}.bind(this);v.remove(this.entity+b).$promise.then(c)}.bind(this);
this.deleteMessage&&0<this.deleteMessage.length?confirm(this.deleteMessage)&&d(c,a):d(c,a)};var e=function(a){for(var b={},d=0;d<this.keys.length;d++)b[this.keys[d]]=a[this.keys[d]];return b}.bind(this);this.hasNext=function(){return this.data&&a<this.data.length-1};this.hasPrevious=function(){return this.data&&0<a};this.order=function(a){m.order=a};this.getActiveValues=function(){this.active&&!this._activeValues&&n.$watch(function(a){return this.active}.bind(this),function(a,b){this._activeValues=
this.getRowValues(this.active)}.bind(this),!0);return this._activeValues};this.__defineGetter__("activeValues",function(){return l.getActiveValues()});this.getRowValues=function(a){var b=[],d;for(d in a)a.hasOwnProperty(d)&&b.push(a[d]);return b};this.next=function(){this.hasNext()||this.nextPage();return this.active=this.copy(this.data[++a],{})};this.nextPage=function(){this.hasNextPage()&&(this.offset=parseInt(this.offset)+parseInt(this.rowsPerPage),this.fetch(m,{success:function(a){if(!a||a.length<
parseInt(this.rowsPerPage))this.offset=parseInt(this.offset)-this.data.length}}))};this.prevPage=function(){this.append||this.preppend||(this.offset=parseInt(this.offset)-this.data.length,0>this.offset?this.offset=0:0<=this.offset&&this.fetch(m,{success:function(a){a&&0!==a.length||(this.offset=0)}}))};this.hasNextPage=function(){return q&&-1!=this.rowsPerPage};this.hasPrevPage=function(){return 0<this.offset&&!this.append&&!this.prepend};this.previous=function(){if(!this.hasPrevious())throw"Dataset Overflor Error";
return this.active=this.copy(this.data[--a],{})};this.goTo=function(c){for(var b=0;b<this.data.length;b++)if(this.data[b][this.key]===c)return a=b,this.active=this.copy(this.data[a],{})};this.getCursor=function(){return a};this.filter=function(a){var b=this.offset;this.offset=0;this.fetch({path:a},{beforeFill:function(a){this.cleanup()},error:function(a){this.offset=b}})};this.cleanup=function(){this.offset=0;this.data=[];this.cursor=-1;this.active=null;q=!1};this.current=function(){return this.active||
this.data[0]};this.fetch=function(c,b){if(!this.busy)if(this.enabled){var d=c||{},g=b||{};d.params=d.params||{};var h=this.entity+(d.path||"");0<this.rowsPerPage&&(d.params.limit=this.rowsPerPage,d.params.offset=this.offset);this.stopAutoPost();m=d;k=!0;this.$promise=p({method:"GET",url:h,params:d.params,headers:this.headers}).success(function(a,c,b,d){k=!1;e(a)}.bind(this)).error(function(a,c,b,d){k=!1;this.handleError(a);g.error&&g.error.call(this,a)}.bind(this));var e=function(c){c&&("[object Array]"!==
Object.prototype.toString.call(c)&&(c=[c]),g.beforeFill&&g.beforeFill.apply(this,this.data),this.prepend&&(this.data=c.concat(this.data)),this.append&&(this.data=this.data.concat(c)),this.prepend||this.append||(this.data=c,this.active=c[0],a=0),g.success&&g.success.call(this,c),q=c.length>=this.rowsPerPage,this.autoPost&&this.startAutoPost())}.bind(this)}else this.cleanup()};this.notifyObservers=function(){for(var a in this.observers)if(this.observers.hasOwnProperty(a)){var b=this.observers[a];f(function(){b.notify.call(b,
this.active)}.bind(this),1)}};this.notify=function(a){if(a){var b=this.watchFilter,b=b.replace(/\{([A-z][A-z|0-9]*)\}/gim,function(b,g){return a.hasOwnProperty(g)?a[g]:""});this.fetch({params:{q:b}})}};this.addObserver=function(a){this.observers.push(a)};this.copy=function(a,b){if(null===a||"[object Object]"!==Object.prototype.toString.call(a))return a;b=b||{};for(var d in a)a.hasOwnProperty(d)&&-1==d.indexOf("$")&&(b[d]=this.copy(a[d]));return b};this.startAutoPost=function(){r=n.$watch(function(){return this.data}.bind(this),
function(a,b){if(this.enabled){var d=a.length-b.length;if(0<d)for(var g=1;g<=d;g++)this.insert(a[a.length-g],function(){});else if(0>d)for(d=b.filter(function(b){return 0==a.filter(function(a){var c;a:{c=e(b);a=e(a);for(var d in c)if(c.hasOwnProperty(d)){if(!a.hasOwnProperty(d)){c=!1;break a}if(c[d]!==a[d]){c=!1;break a}}c=!0}return c}).length}),g=0;g<d.length;g++)this.remove(d[g],function(){})}else r()}.bind(this))};this.stopAutoPost=function(){r&&(r(),r=void 0)}};this.storeDataset=function(b){this.datasets[b.name]=
b};this.initDataset=function(b){var a=new u(b.name);a.entity=b.entity;a.keys=b.keys&&0<b.keys.length?b.keys.split(","):[];a.rowsPerPage=b.rowsPerPage?b.rowsPerPage:100;a.append=b.append;a.prepend=b.prepend;a.endpoint=b.endpoint;a.filterURL=b.filterURL;a.autoPost=b.autoPost;a.deleteMessage=b.deleteMessage;a.enabled=b.enabled;a.offset=b.offset?b.offset:0;if(b.headers&&0<b.headers.length){a.headers={};for(var e=b.headers.trim().split(";"),m,f=0;f<e.length;f++)m=e[f].split(":"),2===m.length&&(a.headers[m[0]]=
m[1])}a.init();this.storeDataset(a);b.lazy||"[object String]"===Object.prototype.toString.call(b.watch)||b.filterURL||a.fetch({params:{}},{success:function(a){a&&0<a.length&&(this.active=a[0],this.cursor=0)}});b.lazy&&b.autoPost&&a.startAutoPost();b.watch&&"[object String]"===Object.prototype.toString.call(b.watch)&&(this.registerObserver(b.watch,a),a.watchFilter=b.watchFilter);b.filterURL&&0<b.filterURL.length&&a.filter(b.filterURL);n[a.name]=a;return window[a.name]=a};this.registerObserver=function(b,
a){this.datasets[b].addObserver(a)};return this}]).directive("datasource",["DatasetManager","$timeout","$parse",function(p,e,f){var n;return{restrict:"E",scope:!0,template:"",link:function(f,b,a){(function(){var b={name:a.name,entity:a.entity,enabled:a.hasOwnProperty("enabled")?"true"===a.enabled:!0,keys:a.keys,endpoint:a.endpoint,lazy:a.hasOwnProperty("lazy")&&""===a.lazy||"true"===a.lazy,append:!a.hasOwnProperty("append")||"true"===a.append,prepend:a.hasOwnProperty("prepend")&&""===a.prepend||"true"===
a.prepend,watch:a.watch,rowsPerPage:a.rowsPerPage,offset:a.offset,filterURL:a.filter,watchFilter:a.watchFilter,deleteMessage:a.deleteMessage,headers:a.headers,autoPost:a.hasOwnProperty("autoPost")&&""===a.autoPost||"true"===a.autoPost},f=!0,q=!0,k=!0,l=p.initDataset(b);a.$observe("filter",function(a){f?e(function(){f=!1}):(e.cancel(n),n=e(function(){l.filter(a)},200))});a.$observe("enabled",function(a){k?e(function(){k=!1}):(l.enabled="true"===a,l.fetch({params:{}}))});a.$observe("entity",function(a){l.entity=
a;q?e(function(){q=!1}):l.fetch({params:{}})})})()}}}]).directive("datasourceName",["DatasetManager","$parse",function(p,e){return{restrict:"A",scope:!0,link:function(f,n,u){f.data=p.datasets;f.data[u.datasourceName]?f.datasource=f.data[u.datasourceName]:(f.datasource={},f.datasource.data=e(u.datasourceName)(f))}}}]);